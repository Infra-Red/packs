#!/bin/bash

set -eo pipefail

cd $(dirname "${BASH_SOURCE[0]}")/..

stack=$1
user="${2:-packs}"

if [[ ! -f ${stack}.json ]]; then
  >&2 echo "No such stack: ${stack:-(not specified)}"
  exit 1
fi

docker pull "cloudfoundry/${stack}"

build() { docker build --build-arg "stack=${stack}" --build-arg "user=${user}" "$@"; }

build -t "${user}/${stack}:latest" -f images/base.Dockerfile ..

build -t "${user}/${stack}:build" --build-arg buildpacks="$(jq -cM . "${stack}.json")" images/build
build -t "${user}/${stack}:run" images/run
# header "building export"
# build -t "${user}/${stack}:export" images/export
build -t "${user}/${stack}:network" images/network

# build -t "${user}/${stack}-test" images/test
